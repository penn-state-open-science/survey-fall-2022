# (PART) Data Analysis & Visualization {-}

# Data Gathering and Cleaning {-}

## Set-up {-}

We ensure that all package dependencies are installed.

```{r set-up}

if (!require(tidyverse)) {
  install.packages("tidyverse")
}
if (!require(googledrive)) {
  install.packages("googledrive")
}

suppressPackageStartupMessages(library("tidyverse")) # for pipe %>%
```

## Download data {-}

Download the data file from the spreadsheet generated by the Google Form into a comma-separated value (CSV) file in a local directory called `csv/`.

Authenticate to Google.
For the time being, you must run `googledrive:drive_auth()` at the console, separate from rendering the protocol via `bookdown::render_book()`.

```{r eval=FALSE}
googledrive::drive_auth()
```

```{r}
if (!dir.exists('csv')) {
  dir.create('csv')
}

if (!file.exists(params$csv_fn)) {
  no_current_csv <- TRUE
  csv_fn <- "csv/open-science-survey-2022-fall.csv"
} else {
  csv_fn <- params$csv_fn
  no_current_csv <- FALSE
}

if (params$update_google_sheet || no_current_csv) {
  googledrive::drive_download(
    file = google_sheet_fn,
    path = csv_fn,
    type = 'csv',
    overwrite = TRUE
  )
}
```

## Clean data {-}

Load the data file.

```{r}
if (file.exists(csv_fn)) {
  survey <- readr::read_csv(csv_fn, show_col_types = FALSE)
} else {
  message("File not found: ", csv_fn)
  survey <- NULL
}
```

Examine the variable names.

```{r}
if (is.null(survey)) {
  warning("Error loading data file")
} else {
  names(survey)
}
```

Let's rename them.

```{r}
full_questions <- names(survey)

short_names <- c(
  "timestamp",
  "campus",
  "department",
  "position",
  "career_stage",
  "data_types",
  "restricted_data",
  "storage_active",
  "importance_sharing_collab",
  "convenience_sharing_collab",
  "barriers_sharing_collab",
  "importance_share_community",
  "obstacles_share_community",
  "funders_require_data_sharing",
  "journals_require_data_sharing",
  "where_shared_widely",
  "equipped_data_mgmt_sharing",
  "create_analysis_code",
  "share_analysis_code",
  "create_other_code",
  "use_code_sharing_tools",
  "funders_require_code_sharing",
  "journals_require_code_sharing",
  "share_materials_community",
  "knowledge_open_science",
  "awareness_FAIR",
  "apply_FAIR",
  "heardof_reproducibility_crisis",
  "my_area_reproducibility_crisis",
  "benefit_psu_center",
  "service_psu_center",
  "comments",
  "contact_info"
)

if (length(short_names) == length(names(survey))) {
  names(survey) <- short_names
} else {
  message("Name vector lengths differ; no change made.")
}
```

